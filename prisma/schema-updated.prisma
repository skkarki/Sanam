generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id              String        @id @default(cuid())
  email           String        @unique
  passwordHash    String?
  firstName       String?
  lastName        String?
  phone           String?
  avatarUrl       String?
  role            UserRole      @default(CUSTOMER)
  emailVerifiedAt DateTime?
  lastLoginAt     DateTime?
  isActive        Boolean       @default(true)
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  addresses       Address[]
  carts           Cart[]
  orders          Order[]
  reviews         Review[]
  wishlist        Wishlist[]
}

model Category {
  id              String     @id @default(cuid())
  name            String
  slug            String     @unique
  description     String?
  parentId        String?
  imagePublicId   String?
  displayOrder    Int        @default(0)
  isActive        Boolean    @default(true)
  metaTitle       String?
  metaDescription String?
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt
  parent          Category?  @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children        Category[] @relation("CategoryHierarchy")
  products        Product[]
}

model Brand {
  id           String    @id @default(cuid())
  name         String    @unique
  slug         String    @unique
  logoPublicId String?
  description  String?
  websiteUrl   String?
  isFeatured   Boolean   @default(false)
  isActive     Boolean   @default(true)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  products     Product[]
}

model Product {
  id               String           @id @default(cuid())
  name             String
  slug             String           @unique
  description      String?
  shortDescription String?
  brandId          String?
  categoryId       String
  productType      ProductType
  gender           GenderType
  basePrice        Float
  compareAtPrice   Float?
  costPrice        Float?
  isActive         Boolean          @default(false)
  isFeatured       Boolean          @default(false)
  isNewArrival     Boolean          @default(true)
  tags             String           @default("")
  materials        String           @default("")
  careInstructions String?
  metaTitle        String?
  metaDescription  String?
  publishedAt      DateTime?
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt
  orderItems       OrderItem[]      @relation("OrderItemProducts")
  brand            Brand?           @relation(fields: [brandId], references: [id])
  category         Category         @relation(fields: [categoryId], references: [id])
  images           ProductImage[]
  variants         ProductVariant[]
  reviews          Review[]
  wishlist         Wishlist[]
}

model ProductVariant {
  id              String         @id @default(cuid())
  productId       String
  sku             String         @unique
  colorName       String
  colorHex        String?
  sizeValue       String
  sizeLabel       String?
  sizeCategory    SizeCategory
  priceAdjustment Float          @default(0)
  weightGrams     Int?
  barcode         String?
  isActive        Boolean        @default(true)
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  cartItems       CartItem[]
  inventory       Inventory?
  orderItems      OrderItem[]    @relation("OrderItemVariants")
  images          ProductImage[]
  product         Product        @relation(fields: [productId], references: [id], onDelete: Cascade)
}

model Inventory {
  id                String         @id @default(cuid())
  variantId         String         @unique
  quantity          Int            @default(0)
  reservedQuantity  Int            @default(0)
  lowStockThreshold Int            @default(5)
  allowBackorder    Boolean        @default(false)
  updatedAt         DateTime       @updatedAt
  variant           ProductVariant @relation(fields: [variantId], references: [id], onDelete: Cascade)
}

model ProductImage {
  id                 String          @id @default(cuid())
  productId          String
  variantId          String?
  cloudinaryPublicId String          @unique @default(cuid())
  altText            String?
  displayOrder       Int             @default(0)
  isPrimary          Boolean         @default(false)
  imageType          ImageType       @default(PRODUCT)
  createdAt          DateTime        @default(now())
  product            Product         @relation(fields: [productId], references: [id], onDelete: Cascade)
  variant            ProductVariant? @relation(fields: [variantId], references: [id], onDelete: Cascade)
}

model Address {
  id                String   @id @default(cuid())
  userId            String
  label             String?
  firstName         String
  lastName          String
  company           String?
  addressLine1      String
  addressLine2      String?
  city              String
  state             String
  postalCode        String
  countryCode       String
  phone             String?
  isDefaultShipping Boolean  @default(false)
  isDefaultBilling  Boolean  @default(false)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Cart {
  id        String     @id @default(cuid())
  userId    String?
  sessionId String?
  currency  String     @default("USD")
  expiresAt DateTime
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  user      User?      @relation(fields: [userId], references: [id], onDelete: Cascade)
  items     CartItem[]
}

model CartItem {
  id        String         @id @default(cuid())
  cartId    String
  variantId String
  quantity  Int
  addedAt   DateTime       @default(now())
  cart      Cart           @relation(fields: [cartId], references: [id], onDelete: Cascade)
  variant   ProductVariant @relation(fields: [variantId], references: [id])
}

model Order {
  id              String      @id @default(cuid())
  orderNumber     String      @unique
  userId          String
  status          OrderStatus @default(PENDING)
  currency        String      @default("USD")
  subtotal        Float
  discountAmount  Float       @default(0)
  shippingAmount  Float       @default(0)
  taxAmount       Float       @default(0)
  totalAmount     Float
  shippingAddress String
  billingAddress  String?
  shippingMethod  String?
  trackingNumber  String?
  trackingUrl     String?
  notes           String?
  adminNotes      String?
  placedAt        DateTime?
  shippedAt       DateTime?
  deliveredAt     DateTime?
  cancelledAt     DateTime?
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  user            User        @relation(fields: [userId], references: [id])
  items           OrderItem[] @relation("OrderItems")
  payments        Payment[]
}

model OrderItem {
  id              String         @id @default(cuid())
  orderId         String
  variantId       String
  quantity        Int
  unitPrice       Float
  totalPrice      Float
  productSnapshot String
  createdAt       DateTime       @default(now())
  productId       String
  order           Order          @relation("OrderItems", fields: [orderId], references: [id], onDelete: Cascade, map: "OrderItem_orderId_fkey")
  product         Product        @relation("OrderItemProducts", fields: [productId], references: [id], map: "OrderItem_productId_fkey")
  variant         ProductVariant @relation("OrderItemVariants", fields: [variantId], references: [id], map: "OrderItem_variantId_fkey")
}

model Payment {
  id                 String          @id @default(cuid())
  orderId            String
  provider           PaymentProvider
  providerPaymentId  String
  providerCustomerId String?
  amount             Float
  currency           String
  status             PaymentStatus
  paymentMethod      String?
  cardLastFour       String?
  cardBrand          String?
  failureReason      String?
  metadata           String          @default("{}")
  createdAt          DateTime        @default(now())
  updatedAt          DateTime        @updatedAt
  order              Order           @relation(fields: [orderId], references: [id])
}

model Review {
  id           String        @id @default(cuid())
  productId    String
  userId       String
  orderItemId  String?
  rating       Int
  title        String?
  comment      String?
  sizeFeedback SizeFeedback?
  isVerified   Boolean       @default(false)
  isApproved   Boolean       @default(false)
  isFeatured   Boolean       @default(false)
  helpfulCount Int           @default(0)
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  product      Product       @relation(fields: [productId], references: [id], onDelete: Cascade)
  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Wishlist {
  id        String   @id @default(cuid())
  userId    String
  productId String
  createdAt DateTime @default(now())
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, productId])
}

model PasswordResetToken {
  id        String   @id @default(cuid())
  email     String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([email])
  @@index([expiresAt])
}

enum UserRole {
  CUSTOMER
  ADMIN
  SUPER_ADMIN
}

enum ProductType {
  CLOTHING
  SHOES
  ACCESSORIES
}

enum GenderType {
  MEN
  WOMEN
  UNISEX
  BOYS
  GIRLS
}

enum SizeCategory {
  CLOTHING_ALPHA
  CLOTHING_NUMERIC
  SHOES_US
  SHOES_UK
  SHOES_EU
  ONE_SIZE
}

enum ImageType {
  PRODUCT
  LIFESTYLE
  SIZE_GUIDE
  DETAIL
}

enum OrderStatus {
  PENDING
  CONFIRMED
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELLED
  REFUNDED
  FAILED
}

enum PaymentProvider {
  STRIPE
  PAYPAL
  MANUAL
  ESEWA
  KHALTI
}

enum PaymentStatus {
  PENDING
  PROCESSING
  SUCCEEDED
  FAILED
  CANCELLED
  REFUNDED
  PARTIALLY_REFUNDED
}

enum SizeFeedback {
  RUNS_SMALL
  TRUE_TO_SIZE
  RUNS_LARGE
}
